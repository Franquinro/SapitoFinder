<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5.3.2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <!-- Iconos de Bootstrap para el popover -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <title>SapitoFinder 游댌</title>

  <style>
    body { background-color: #f8f9fa; }
    main.container {
      max-width: 800px;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }
    .popover-header { font-weight: bold; }
    #results-container { display: grid; gap: 0.75rem; }
    .result-card {
      border: none;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .result-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }
    .result-card:nth-child(odd) .card-header { background-color: #0d6efd; color: white; }
    .result-card:nth-child(even) .card-header { background-color: #6c757d; color: white; }
    mark { background-color: #fdff85; padding: 0.1em 0.2em; border-radius: 3px; }
  </style>
</head>

<body>
  <main class="container p-4 my-4">
    <div class="text-center mb-4">
      <h1 class="display-5 d-inline-flex align-items-center">
        SapitoFinder 
        <img src="android-chrome-192x192.png" alt="Icono SapitoFinder" style="height: 6.0rem; margin-left: 0.75rem;">
      </h1>
      <p class="lead text-muted">Buscador de equipos y componentes</p>
    </div>

    <form id="search-form" onsubmit="return false;">
      <div class="row g-2 mb-3">
        <div class="col-md">
          <div class="form-floating">
            <input type="text" class="form-control" id="desc" placeholder="Introduce + 2 letras" disabled>
            <label for="desc">Descripci칩n</label>
          </div>
        </div>
        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <span class="input-group-text" id="inputGroup-sizing-default"><a href="#" title="Consejo" data-toggle="popover" data-placement="bottom" data-html="true" data-content="Puedes utilizar espacios para separar.<br>Ej. 'V1 A01 MVC'."><span class="badge badge-pill badge-info">?</span></a>&nbsp;Ubicaci칩n</span>
          </div>
          <input id="ubi" type="text" class="form-control" aria-label="Default" aria-describedby="inputGroup-sizing-default" placeholder="Completa ubicaci칩n" value="T8T-">
        </div>
        <div class="col-md">
          <div class="form-floating">
            <input type="text" class="form-control" id="kks" placeholder="Introduce + 2 letras" disabled>
            <label for="kks">KKS / N췈 Pieza</label>
          </div>
        </div>
      </div>
      
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="highlight-criteria" disabled>
          <label class="form-check-label" for="highlight-criteria">Resaltar criterios</label>
        </div>
        <button id="clear-button" type="button" class="btn btn-outline-secondary" disabled>Limpiar</button>
      </div>
    </form>

    <div id="searching-spinner" class="text-center my-4" style="display:none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Buscando...</span>
      </div>
    </div>

    <div id="results-feedback" class="alert" role="alert" style="display:none;"></div>
    
    <div id="results-container"></div>
  </main>

  <footer class="text-center text-muted py-3">
    <small>춸FQR춸</small>
  </footer>

  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  
  <!-- L칈NEA CORREGIDA: Bootstrap 5.3.2 JS Bundle con el hash de integridad correcto -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

  <script>
    $(document).ready(function() {
      let equipos = [];
      let debounceTimer;

      const $desc = $('#desc');
      const $ubi = $('#ubi');
      const $kks = $('#kks');
      const $highlight = $('#highlight-criteria');
      const $spinner = $('#searching-spinner');
      const $feedback = $('#results-feedback');
      const $container = $('#results-container');
      const $clearBtn = $('#clear-button');
      
      // Habilitar controles del formulario
      const enableForm = (enable) => {
        $('input.form-control, #highlight-criteria, #clear-button').prop('disabled', !enable);
      };
      
      // Inicializar Popovers (ahora funcionar치 porque bootstrap est치 definido)
      const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
      popoverTriggerList.map(function (popoverTriggerEl) {
          return new bootstrap.Popover(popoverTriggerEl);
      });

      // Cargar los datos del JSON
      $feedback.removeClass().addClass('alert alert-info').text('Cargando datos de equipos...').show();
      $.getJSON("listado_equipos_mayo_2025.json")
        .done(function(data) {
          equipos = data;
          enableForm(true); // Habilitar el formulario
          $feedback.hide();
          $desc.focus();
        })
        .fail(function() {
          enableForm(false);
          $feedback.removeClass().addClass('alert alert-danger').text('Error: No se pudo cargar el archivo de datos. Por favor, recarga la p치gina.').show();
        });

      const performSearch = () => {
        const descripcion = $desc.val().toUpperCase().trim();
        const ubicacion = $ubi.val().toUpperCase().trim();
        const kks = $kks.val().toUpperCase().trim();

        if (descripcion.length > 2 || ubicacion.length > 4 || kks.length > 2) {
          $spinner.show();
          $container.hide();
          $feedback.hide();
          
          setTimeout(() => {
            const resultados = filtrarEquipos(descripcion, ubicacion, kks);
            mostrarResultados(resultados);
          }, 250);
        } else {
          limpiarResultados();
        }
      };

      const filtrarEquipos = (descripcion, ubicacion, kks) => {
        const descTerms = descripcion.split(' ').filter(Boolean);
        const ubiTerms = ubicacion.split(' ').filter(Boolean);
        const kksTerms = kks.split(' ').filter(Boolean);
        
        return equipos.filter(equipo => {
          const cumpleDescripcion = descripcion.length <= 2 || descTerms.every(term => equipo["Denominaci칩n"].toUpperCase().includes(term));
          const cumpleUbicacion = ubicacion.length <= 4 || ubiTerms.every(term => (equipo["Ubicac.t칠cnica"] || "").toUpperCase().includes(term));
          const cumpleKks = kks.length <= 2 || kksTerms.every(term => (equipo["N췈Pieza fabric."] || "").toUpperCase().includes(term));
          return cumpleDescripcion && cumpleUbicacion && cumpleKks;
        });
      };

      const mostrarResultados = (resultados) => {
        $spinner.hide();
        limpiarResultados();

        if (resultados.length > 0) {
          $feedback.removeClass().addClass('alert alert-success').html(`<strong>${resultados.length}</strong> equipos encontrados.`).show();
          
          let html = resultados.map(equipo => `
            <div class="card result-card">
              <div class="card-header fw-bold">${equipo["Denominaci칩n"]}</div>
              <div class="card-body">
                <p class="mb-1"><strong>Equipo:</strong> ${equipo["Equipo"]}</p>
                <p class="mb-1"><strong>Ubicaci칩n:</strong> ${equipo["Ubicac.t칠cnica"]}</p>
                ${equipo["N췈Pieza fabric."] ? `<p class="mb-0"><strong>KKS:</strong> ${equipo["N췈Pieza fabric."]}</p>` : ''}
              </div>
            </div>
          `).join('');

          if ($highlight.is(':checked')) {
            const terminos = [...$desc.val().split(' '), ...$kks.val().split(' ')].filter(t => t.length > 2);
            if (terminos.length > 0) {
              const regex = new RegExp(`(${terminos.join('|')})`, 'gi');
              html = html.replace(regex, `<mark>$1</mark>`);
            }
          }
          
          $container.html(html).show();
        } else {
          $feedback.removeClass().addClass('alert alert-warning').html('<strong>Sin resultados.</strong> Prueba con otros criterios de b칰squeda.').show();
        }
      };

      const limpiarResultados = () => {
        $container.empty().hide();
        $feedback.hide();
      };

      const limpiarFormulario = () => {
        $desc.val('');
        $ubi.val('T8T-');
        $kks.val('');
        limpiarResultados();
        $spinner.hide();
        $desc.focus();
      };
      
      $desc.add($ubi).add($kks).on('keyup', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(performSearch, 300);
      });
      
      $highlight.on('change', performSearch);
      
      $clearBtn.on('click', limpiarFormulario);

      $ubi.on('input', function() {
        if (!this.value.startsWith('T8T-')) {
            this.value = 'T8T-';
        }
      });
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5.3.2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <!-- Iconos de Bootstrap para el popover -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <title>SapitoFinder 游댌</title>

  <style>
    /* Estilo general para un look m치s limpio */
    body {
      background-color: #f8f9fa; /* Un gris muy claro de fondo */
    }

    /* Contenedor principal con sombra y bordes redondeados */
    main.container {
      max-width: 800px;
      background-color: white;
      border-radius: 0.5rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }

    /* Estilo para el Popover de ayuda */
    .popover-header {
        font-weight: bold;
    }

    /* Contenedor de resultados con espaciado entre tarjetas */
    #results-container {
      display: grid;
      gap: 0.75rem; /* Espacio entre las tarjetas */
    }
    
    /* Estilo para las tarjetas de resultado */
    .result-card {
      border: none;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    
    .result-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }

    /* Colores alternos para las cabeceras de las tarjetas */
    .result-card:nth-child(odd) .card-header {
      background-color: #0d6efd; /* Primary de Bootstrap */
      color: white;
    }

    .result-card:nth-child(even) .card-header {
      background-color: #6c757d; /* Secondary de Bootstrap */
      color: white;
    }

    /* Estilo para el texto resaltado */
    mark {
      background-color: #fdff85;
      padding: 0.1em 0.2em;
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <main class="container p-4 my-4">
    <!-- Encabezado -->
    <div class="text-center mb-4">
      <h1 class="display-5">SapitoFinder 游댌</h1>
      <p class="lead text-muted">Buscador de equipos y componentes</p>
    </div>

    <!-- Formulario de B칰squeda -->
    <form id="search-form" onsubmit="return false;">
      <div class="row g-2 mb-3">
        <!-- Input Descripci칩n -->
        <div class="col-md">
          <div class="form-floating">
            <input type="text" class="form-control" id="desc" placeholder="Introduce + 2 letras">
            <label for="desc">Descripci칩n</label>
          </div>
        </div>
        <!-- Input Ubicaci칩n -->
        <div class="col-md">
          <div class="form-floating">
            <input type="text" class="form-control" id="ubi" placeholder="Completa ubicaci칩n" value="T8T-">
            <label for="ubi">Ubicaci칩n 
              <a href="#" tabindex="0" class="text-decoration-none" data-bs-toggle="popover" data-bs-trigger="hover focus" data-bs-title="Consejo de B칰squeda" data-bs-content="Puedes usar espacios para buscar m칰ltiples t칠rminos. Ej: 'V1 A01 MVC'">
                <i class="bi bi-info-circle"></i>
              </a>
            </label>
          </div>
        </div>
        <!-- Input KKS -->
        <div class="col-md">
          <div class="form-floating">
            <input type="text" class="form-control" id="kks" placeholder="Introduce + 2 letras">
            <label for="kks">KKS / N췈 Pieza</label>
          </div>
        </div>
      </div>
      
      <!-- Opciones y Botones -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="highlight-criteria">
          <label class="form-check-label" for="highlight-criteria">Resaltar criterios</label>
        </div>
        <button id="clear-button" type="button" class="btn btn-outline-secondary">Limpiar</button>
      </div>
    </form>

    <!-- Indicador de Carga (Spinner) -->
    <div id="searching-spinner" class="text-center my-4" style="display:none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Buscando...</span>
      </div>
    </div>

    <!-- Mensaje de Resultados -->
    <div id="results-feedback" class="alert" role="alert" style="display:none;"></div>
    
    <!-- Contenedor para los resultados -->
    <div id="results-container"></div>
  </main>

  <footer class="text-center text-muted py-3">
    <small>춸FQR춸</small>
  </footer>

  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <!-- Bootstrap 5.3.2 JS Bundle (incluye Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95oG4sF8sL2ReYImL3pB1YcNl8xFNcJoAnx" crossorigin="anonymous"></script>

  <script>
    $(document).ready(function() {
      let equipos = [];
      let debounceTimer;

      // Cache de elementos del DOM para mejor rendimiento
      const $desc = $('#desc');
      const $ubi = $('#ubi');
      const $kks = $('#kks');
      const $highlight = $('#highlight-criteria');
      const $spinner = $('#searching-spinner');
      const $feedback = $('#results-feedback');
      const $container = $('#results-container');
      const $clearBtn = $('#clear-button');

      // Inicializar Popovers de Bootstrap 5
      const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
      popoverTriggerList.map(function (popoverTriggerEl) {
          return new bootstrap.Popover(popoverTriggerEl);
      });

      // Cargar los datos del JSON
      $.getJSON("listado_equipos_mayo_2025.json")
        .done(function(data) {
          equipos = data;
          // Habilitar los campos de b칰squeda una vez que los datos est치n listos
          $('input.form-control').prop('disabled', false);
        })
        .fail(function() {
          $feedback.removeClass().addClass('alert alert-danger').text('Error: No se pudo cargar el archivo de datos.').show();
        });

      // --- FUNCIONES PRINCIPALES ---

      // Funci칩n que se ejecuta al buscar
      const performSearch = () => {
        const descripcion = $desc.val().toUpperCase().trim();
        const ubicacion = $ubi.val().toUpperCase().trim();
        const kks = $kks.val().toUpperCase().trim();

        // Condici칩n para iniciar la b칰squeda
        if (descripcion.length > 2 || ubicacion.length > 4 || kks.length > 2) {
          $spinner.show();
          $container.hide();
          $feedback.hide();

          // Simula una peque침a demora para que el spinner sea visible
          setTimeout(() => {
            const resultados = filtrarEquipos(descripcion, ubicacion, kks);
            mostrarResultados(resultados);
          }, 250);
        } else {
          // Si no se cumplen los criterios, limpiar la pantalla
          limpiarResultados();
        }
      };

      const filtrarEquipos = (descripcion, ubicacion, kks) => {
        const descTerms = descripcion.split(' ').filter(Boolean);
        const ubiTerms = ubicacion.split(' ').filter(Boolean);
        const kksTerms = kks.split(' ').filter(Boolean);
        
        return equipos.filter(equipo => {
          const cumpleDescripcion = descripcion.length <= 2 || descTerms.every(term => equipo["Denominaci칩n"].toUpperCase().includes(term));
          const cumpleUbicacion = ubicacion.length <= 4 || ubiTerms.every(term => (equipo["Ubicac.t칠cnica"] || "").toUpperCase().includes(term));
          const cumpleKks = kks.length <= 2 || kksTerms.every(term => (equipo["N췈Pieza fabric."] || "").toUpperCase().includes(term));
          return cumpleDescripcion && cumpleUbicacion && cumpleKks;
        });
      };

      const mostrarResultados = (resultados) => {
        $spinner.hide(); // Ocultar el spinner ANTES de mostrar resultados
        limpiarResultados();

        if (resultados.length > 0) {
          $feedback.removeClass().addClass('alert alert-success').html(`<strong>${resultados.length}</strong> equipos encontrados.`).show();
          
          let html = resultados.map(equipo => `
            <div class="card result-card">
              <div class="card-header fw-bold">${equipo["Denominaci칩n"]}</div>
              <div class="card-body">
                <p class="mb-1"><strong>Equipo:</strong> ${equipo["Equipo"]}</p>
                <p class="mb-1"><strong>Ubicaci칩n:</strong> ${equipo["Ubicac.t칠cnica"]}</p>
                ${equipo["N췈Pieza fabric."] ? `<p class="mb-0"><strong>KKS:</strong> ${equipo["N췈Pieza fabric."]}</p>` : ''}
              </div>
            </div>
          `).join('');

          // Resaltar si la opci칩n est치 activa
          if ($highlight.is(':checked')) {
            const terminos = [...$desc.val().split(' '), ...$kks.val().split(' ')].filter(t => t.length > 2);
            if (terminos.length > 0) {
              const regex = new RegExp(`(${terminos.join('|')})`, 'gi');
              html = html.replace(regex, `<mark>$1</mark>`);
            }
          }
          
          $container.html(html).show();
        } else {
          $feedback.removeClass().addClass('alert alert-warning').html('<strong>Sin resultados.</strong> Prueba con otros criterios de b칰squeda.').show();
        }
      };

      const limpiarResultados = () => {
        $container.empty().hide();
        $feedback.hide();
      };

      const limpiarFormulario = () => {
        $desc.val('');
        $ubi.val('T8T-');
        $kks.val('');
        limpiarResultados();
        $spinner.hide();
        $desc.focus();
      };
      
      // --- MANEJADORES DE EVENTOS ---

      // Evento unificado para los campos de texto con "debounce"
      $desc.add($ubi).add($kks).on('keyup', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(performSearch, 300); // Espera 300ms despu칠s de la 칰ltima tecla
      });
      
      // Evento para el interruptor de resaltar
      $highlight.on('change', performSearch);
      
      // Evento para el bot칩n de limpiar
      $clearBtn.on('click', limpiarFormulario);

      // Prevenir que la ubicaci칩n se escriba sin el prefijo 'T8T-'
      $ubi.on('keydown', function(e) {
        const oldValue = $(this).val();
        setTimeout(() => {
          if (this.value.indexOf('T8T-') !== 0) {
            $(this).val(oldValue);
          }
        }, 1);
      });
    });
  </script>
</body>
</html>
